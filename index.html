<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>CALIPH - FarTHErHOOD</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Top chrome (iOS Notes vibe) -->
  <div class="top-chrome">
    <!-- Back button (left) -->
    <a href="#" class="nav-round" aria-label="Back">
      <img src="back.png" alt="Back" />
    </a>

    <!-- Right capsule (share + more) -->
    <div class="nav-capsule" role="group" aria-label="Actions">
      <a href="#" class="nav-capsule-btn" aria-label="Share">
        <img src="share.png" alt="Share" />
      </a>
      <a href="#" class="nav-capsule-btn" aria-label="More">
        <img src="more.png" alt="More" />
      </a>
    </div>
  </div>

  <div class="container">
    <main>
      <p class="note-meta">May 14, 2025 at 8:49 PM — Shared</p>
      <h1>CALIPH - <mark>FarTHErHOOD</mark></h1>

      <p class="intro">
        A collection of stories, some connected others not about <mark>father</mark>hood and coparenting in the black community and how the lack thereof affects everyone differently.
      </p>

      <div class="audio-wrapper" id="audioWrapper"></div>

      <!-- Optional section (keep or remove) -->
      <div class="messages-section">
        <h2>Notes from Listeners</h2>
        <div class="message">
          <p><strong>Coming soon</strong></p>
          <p>(Listener notes can live here when you’re ready.)</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Bottom chrome (floating pill + compose) -->
  <div class="bottom-chrome" aria-label="Bottom actions">
    <div class="bottom-pill">
      <a href="#" class="bottom-icon" aria-label="Subscribe">
        <img src="sub.png" alt="Subscribe" />
      </a>
      <a href="#" class="bottom-icon" aria-label="Buy / Download">
        <img src="buy.png" alt="Buy / Download" />
      </a>
      <a href="https://your-merch-link.com" class="bottom-icon" aria-label="Merch">
        <img src="draw.png" alt="Merch" />
      </a>
    </div>

    <a href="#" class="compose-fab" aria-label="Add note">
      <img src="note.png" alt="Add Note" />
    </a>
  </div>

  <!-- Shared Audio Player -->
  <audio id="sharedAudio" preload="metadata"></audio>

  <!-- Transcript Modal (iOS-style sheet) -->
  <div class="modal" id="transcriptModal" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="modal-sheet" role="dialog" aria-modal="true" aria-label="Transcript">
      <div class="sheet-handle"></div>

      <div class="sheet-top">
        <button class="sheet-ghost" id="sheetMore" aria-label="More">•••</button>
        <button class="sheet-done" id="sheetDone" aria-label="Done">✓</button>
      </div>

      <div class="sheet-title" id="sheetTitle">CALIPH - STORY TIME</div>
      <div class="sheet-meta" id="sheetMeta">2/28/25, 12:40 AM <span class="dot">•</span> 02:07</div>

      <div class="sheet-body" id="sheetBody"></div>

      <!-- Real audio controls -->
      <div class="sheet-player">
        <div class="sheet-timer" id="sheetTimer">00:00.00</div>

        <div class="sheet-controls">
          <button class="sheet-skip" id="btnBack15" aria-label="Back 15 seconds">⟲15</button>
          <button class="sheet-play" id="btnModalPlay" aria-label="Play/Pause">▶</button>
          <button class="sheet-skip" id="btnFwd15" aria-label="Forward 15 seconds">15⟳</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sharedAudio = document.getElementById("sharedAudio");
    const audioWrapper = document.getElementById("audioWrapper");

    const modal = document.getElementById("transcriptModal");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const sheetDone = document.getElementById("sheetDone");

    const sheetTitle = document.getElementById("sheetTitle");
    const sheetMeta  = document.getElementById("sheetMeta");
    const sheetBody  = document.getElementById("sheetBody");
    const sheetTimer = document.getElementById("sheetTimer");

    const btnModalPlay = document.getElementById("btnModalPlay");
    const btnBack15 = document.getElementById("btnBack15");
    const btnFwd15  = document.getElementById("btnFwd15");

    const tracks = [
      {
        title: "CALIPH - STORY TIME",
        date: "Feb 28, 2025 at 12:40 AM",
        duration: "02:07",
        file: "audio/storytime.mp3",
        transcript:
`Little little place between the oh let's switch the conversation up a bit
niggas ain't saying shit and I had enough of it
I won't give a fuck what you saying
I'm hustle me so why you at a war with your image
peace is puzzling and niggas like you let it talk down on a nigga looking like me
cause I walk down on a nigga
do not be less than likely to be
Now what would you say if a nigga like me was your father?`,
        description: "Song about the accidental conception of a child in the black community"
      },
      {
        title: "CALIPH - EATER JAMES",
        date: "Feb 28, 2025 at 12:45 AM",
        duration: "02:00",
        file: "audio/eaterjames.mp3",
        transcript:
`All right, okay, all right…
(All right, okay, all right…)
go, go, okay, right, go…`,
        description: "A song about secret black love that leads to a bad relationship, failed coparenting"
      },
      {
        title: "CALIPH - BLUE CORNER",
        date: "Feb 13, 2025 at 5:03 PM",
        duration: "02:00",
        file: "audio/bluecorner.mp3",
        transcript:
`The streets talking…
I could care less where I'm from…
we find peace in comparing Nike Air…`,
        description: "A song about a tragedy as a result of failed co parenting."
      },
      {
        title: "CALIPH - OBESERVATIONS / A DOLLAR AND A DAD",
        date: "Feb 28, 2025 at 12:55 AM",
        duration: "02:00",
        file: "audio/dollardad.mp3",
        transcript:
`Conversations switchin up…
niggas always act weird when it's time to give it up…`,
        description: "Crackhead dad encounters his son and opens up."
      },
      {
        title: "CALIPH - SEEDS",
        date: "Feb 28, 2025 at 12:43 AM",
        duration: "02:00",
        file: "audio/seeds.mp3",
        transcript:
`The world getting colder than ever…
it's getting harder to hold the dinero…`,
        description: "Outro about wanting kids but with fear of doing it with the wrong woman."
      }
    ];

    let currentIndex = -1;     // which track is loaded/active
    let modalIndex = -1;       // which track modal is showing
    let rafId = null;

    function renderTracks() {
      audioWrapper.innerHTML = "";

      tracks.forEach((track, i) => {
        const preview = escapeHtml(track.transcript)
          .split('\n')
          .filter(Boolean)
          .slice(0,2)
          .join(' ');

        const html = `
          <section class="audio-card" data-index="${i}">
            <div class="card-head">
              <div class="card-left">
                <div class="card-title">${track.title}</div>
                <div class="card-sub">${track.date}</div>
                <div class="card-sub">Audio · 2m</div>
              </div>

              <button class="play-pill" id="btn-${i}" onclick="togglePlay(${i})" aria-label="Play">
                <span class="play-icon" id="icon-${i}">▶</span>
                <span class="play-text" id="text-${i}">Play</span>
              </button>
            </div>

            <div class="card-divider"></div>

            <div class="card-transcript" role="button" tabindex="0"
              onclick="openTranscript(${i})"
              onkeydown="if(event.key==='Enter' || event.key===' ') openTranscript(${i});">
              <div class="t-label">Transcript</div>
              <div class="t-preview">${preview}</div>
            </div>
          </section>

          <p class="description">${track.description}</p>
        `;

        audioWrapper.insertAdjacentHTML("beforeend", html);
      });
    }

    function ensureTrackLoaded(index) {
      if (index < 0 || index >= tracks.length) return false;

      // If a different track is requested, load it
      if (currentIndex !== index) {
        // reset previous card button
        if (currentIndex !== -1) setCardButtonState(currentIndex, false);

        currentIndex = index;
        sharedAudio.src = tracks[index].file;
      }
      return true;
    }

    function togglePlay(index) {
      if (!ensureTrackLoaded(index)) return;

      const same = currentIndex === index;
      const isPlaying = !sharedAudio.paused && same;

      if (isPlaying) {
        sharedAudio.pause();
        setCardButtonState(index, false);
        syncModalPlayButton();
        return;
      }

      sharedAudio.play().then(() => {
        setCardButtonState(index, true);
        syncModalPlayButton();
      }).catch(() => {
        setCardButtonState(index, false);
        syncModalPlayButton();
      });
    }

    function setCardButtonState(index, isPlaying) {
      const icon = document.getElementById(`icon-${index}`);
      const text = document.getElementById(`text-${index}`);
      const btn  = document.getElementById(`btn-${index}`);
      if (!icon || !text || !btn) return;

      if (isPlaying) {
        icon.textContent = "⏸";
        text.textContent = "Pause";
        btn.classList.add("is-playing");
      } else {
        icon.textContent = "▶";
        text.textContent = "Play";
        btn.classList.remove("is-playing");
      }
    }

    function openTranscript(index) {
      modalIndex = index;

      const t = tracks[index];
      sheetTitle.textContent = t.title;
      sheetMeta.innerHTML = `${formatModalDate(t.date)} <span class="dot">•</span> ${t.duration}`;
      sheetBody.textContent = t.transcript;

      // Show modal
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-lock");

      // Sync play button + timer immediately
      syncModalPlayButton();
      startTimerLoop();
    }

    function closeTranscript() {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-lock");
      stopTimerLoop();
    }

    modalBackdrop.addEventListener("click", closeTranscript);
    sheetDone.addEventListener("click", closeTranscript);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) closeTranscript();
    });

    // ===== Modal control wiring (REAL AUDIO) =====
    btnModalPlay.addEventListener("click", () => {
      if (modalIndex === -1) return;

      // Ensure modal track is loaded; do NOT auto-play on open, only when tapped
      ensureTrackLoaded(modalIndex);

      if (!sharedAudio.paused) {
        sharedAudio.pause();
        setCardButtonState(currentIndex, false);
      } else {
        sharedAudio.play().then(() => {
          setCardButtonState(currentIndex, true);
        }).catch(() => {
          // ignore
        });
      }

      syncModalPlayButton();
    });

    btnBack15.addEventListener("click", () => seekBy(-15));
    btnFwd15.addEventListener("click", () => seekBy(15));

    function seekBy(seconds) {
      if (!sharedAudio.src) return;
      const t = sharedAudio.currentTime || 0;
      const next = Math.max(0, t + seconds);
      sharedAudio.currentTime = next;
      // update immediately
      updateTimer();
    }

    function syncModalPlayButton() {
      // Only show pause if modal is open AND the modal track is the one playing
      const modalOpen = modal.classList.contains("open");
      if (!modalOpen) return;

      const isModalTrackActive = (modalIndex !== -1 && currentIndex === modalIndex);
      const playing = isModalTrackActive && !sharedAudio.paused;

      btnModalPlay.textContent = playing ? "⏸" : "▶";
    }

    // Keep modal button + card buttons in sync with native audio events
    sharedAudio.addEventListener("play", () => {
      if (currentIndex !== -1) setCardButtonState(currentIndex, true);
      syncModalPlayButton();
    });

    sharedAudio.addEventListener("pause", () => {
      if (currentIndex !== -1) setCardButtonState(currentIndex, false);
      syncModalPlayButton();
    });

    sharedAudio.addEventListener("ended", () => {
      if (currentIndex !== -1) setCardButtonState(currentIndex, false);
      syncModalPlayButton();
      updateTimer();

      // Auto-advance to next track like Notes (optional)
      if (currentIndex + 1 < tracks.length) {
        togglePlay(currentIndex + 1);

        // If modal is open, update modal content to follow the new track
        if (modal.classList.contains("open")) {
          openTranscript(currentIndex);
        }
      }
    });

    sharedAudio.addEventListener("timeupdate", () => {
      if (modal.classList.contains("open")) updateTimer();
    });

    // ===== Timer loop (smooth) =====
    function startTimerLoop() {
      stopTimerLoop();
      const loop = () => {
        if (modal.classList.contains("open")) {
          updateTimer();
          rafId = requestAnimationFrame(loop);
        }
      };
      rafId = requestAnimationFrame(loop);
    }

    function stopTimerLoop() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }

    function updateTimer() {
      // Only show running time if modal track is active; else show 00:00.00
      const isModalTrackActive = (modalIndex !== -1 && currentIndex === modalIndex && sharedAudio.src);
      const t = isModalTrackActive ? (sharedAudio.currentTime || 0) : 0;
      sheetTimer.textContent = formatTimer(t);
    }

    function formatTimer(seconds) {
      const s = Math.max(0, seconds);
      const mm = Math.floor(s / 60);
      const ss = Math.floor(s % 60);
      const cs = Math.floor((s - Math.floor(s)) * 100); // centiseconds

      const mmStr = String(mm).padStart(2, "0");
      const ssStr = String(ss).padStart(2, "0");
      const csStr = String(cs).padStart(2, "0");

      return `${mmStr}:${ssStr}.${csStr}`;
    }

    // ===== Utilities =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatModalDate(dateStr) {
      // You can keep it simple (matches vibe)
      // "Feb 28, 2025 at 12:40 AM" -> "2/28/25, 12:40 AM"
      return dateStr
        .replace("Jan ", "1/").replace("Feb ", "2/").replace("Mar ", "3/")
        .replace("Apr ", "4/").replace("May ", "5/").replace("Jun ", "6/")
        .replace("Jul ", "7/").replace("Aug ", "8/").replace("Sep ", "9/")
        .replace("Oct ", "10/").replace("Nov ", "11/").replace("Dec ", "12/")
        .replace(", 2025", "/25")
        .replace(" at ", ", ");
    }

    renderTracks();
    updateTimer();
  </script>
</body>
</html>